{% load luzfcb_djdocuments_tags %}

{% for form in assinaturas_forms %}
    <div class="assinatura_object_div_{{ form.instance.pk }} div-modal">
        <div class="modal fade bs-example-modal-lg assinatura_object_modal_{{ form.instance.pk }}" tabindex="-1"
             role="dialog"
             aria-labelledby="myLargeModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">

                    <div class="panel panel-info">
                        <div class="panel-heading">Assinar Documento</div>
                        <div class="panel-body">
                            <form class="form-horizontal form-assinar" method="post"
                                  id="form_{{ form.instance|class_name|lower }}_{{ form.instance.pk }}"
                                  action="{{ form.instance.get_url_para_assinar }}">
                                <fieldset>
                                    <legend>Tem certeza que deseja assinar o documento
                                        "{{ form.instance.documento_assunto|remover_tags_html }}"
                                        número: {{ form.instance.documento_identificador_versao }} ?
                                    </legend>

                                    {% include "luzfcb_djdocuments/django_form_content.html" with form=form %}

                                    <div class="form-group">
                                        <div class="col-sm-offset-2 col-sm-10">
                                            <button type="submit" class="btn btn-success">Assinar Documento</button>
                                        </div>
                                    </div>
                                </fieldset>
                            </form>

                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
    <div id="modal_adicionar_assinantes">
        {% if not object.esta_assinado_e_finalizado and adicionar_assinantes_form_instance %}

            <div class="assinatura_object_div_{{ adicionar_assinantes_form_instance.instance.pk }} div-modal">
                <div class="modal fade bs-example-modal-lg assinatura_object_modal_{{ adicionar_assinantes_form_instance.instance.pk }}" tabindex="-1"
                     role="dialog"
                     aria-labelledby="myLargeModalLabel">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">

                            <div class="panel panel-info">
                                <div class="panel-heading">Escolha um ou mais grupos assinantes, para criar uma nova
                                    pendência de assinatura para os mesmos
                                </div>
                                <div class="panel-body">
                                    {#                {% url 'documentos:adicionar_assinantes' slug=document_object.pk_uuid as adicionar_assinantes_url %}#}

                                    <form class="form-horizontal" action="{{ adicionar_assinantes_form_action }}"
                                          method="post">
                                        <fieldset>
                                            {#                        <legend>Tem certeza que deseja assinar o documento "{{ object.assunto|remover_tags_html }}"#}
                                            {#                            número: {{ object.identificador_versao }} ?</legend>#}
                                            {% csrf_token %}
                                            {% if adicionar_assinantes_form_instance.errors %}
                                                <div class="form-group">
                                                    <div class="col-sm-12">
                                                        <div class="alert alert-danger alert-dismissible" role="alert">
                                                            <button type="button" class="close" data-dismiss="alert"
                                                                    aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                            Selecione um dos modelos para criar um novo documento.
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}

                                            {% for form_field in adicionar_assinantes_form_instance %}
                                                <div class="form-group">
                                                    <label for="{{ form_field.id_for_label }}"
                                                           class="col-sm-2 control-label">{{ form_field.label }}:</label>
                                                    <div class="col-sm-10">
                                                        {{ form_field }}
                                                    </div>
                                                </div>
                                            {% endfor %}

                                            <div class="form-group">
                                                <div class="col-sm-offset-2 col-sm-10">
                                                    <button type="submit" class="btn btn-primary">Adicionar
                                                        selecionados
                                                    </button>
                                                </div>
                                            </div>
                                        </fieldset>
                                    </form>

                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>


        {% endif %}

    </div>
{% endfor %}


{% if assinatura_form_media %}

    {{ assinatura_form_media }}
    <script type="application/javascript">


        (function (window, jQuery) {
            var forms = jQuery('.form-assinar');
            $(forms).each(function () {
                var $formulario = $(this);
                var excluir_modal_agora = false;
                var $botao_salvar = $('button[type=submit]', $formulario);
                var modal = $formulario.parents('.modal');
                var div_modal = $formulario.parents('.div-modal');
                $botao_salvar.click(function (event) {
                    event.preventDefault();
                    $formulario.submit();

                });

                $(modal).on('hidden.bs.modal', function () {
                    var inputs = $(':input:enabled:not([readonly]):not([disabled])', $formulario);
                    clean_form_errors(inputs);
                    if (excluir_modal_agora === true) {
                        //$(this).exclude();
                        div_modal.remove();
                        window.location.reload(true);
                    }
                });

                $(modal).on('shown.bs.modal', function () {


                    var first_el = $(':input:enabled:not([readonly]):not([disabled]):not(button):first', $formulario);
                    if ('select2-hidden-accessible') {

                    }
                    first_el.attr('style', 'border: 6px solid #c30000;');
                    first_el.focus();
                    console.log('passou aqui: ' + $(first_el));
                });
                var clean_form_errors = function (serialized_array) {

                    for (var item in serialized_array) {
                        if (serialized_array.hasOwnProperty(item)) {
                            var input_id = 'id_' + serialized_array[item].name;
                            var label_search = "label[for='" + input_id + "']";
                            $(label_search).parents('div:first').removeClass('has-error');
                            $('.autoadded', $formulario).remove();
                        }
                    }
                };
                $formulario.submit(function (event) {
                    // Stop form from submitting normally
                    event.preventDefault();
                    $botao_salvar.prop('disabled', true);
                    var $form = jQuery(this);
                    var conteudo = $form.serializeArray();
                    clean_form_errors(conteudo);
                    var url = $form.attr("action").replace(/\s/g, "");
                    var posting = $.post(url, conteudo, 'JSON');

                    // process fail logic
                    posting.fail(function (jqXHR, textStatus, errorThrown) {

                        console.log('textStatus: ' + textStatus);
                        console.log('errorThrown:' + errorThrown);
                        var response = jqXHR.responseJSON;
                        for (var key in response.errors) {
                            if (response.errors.hasOwnProperty(key)) {
                                var el_text = '<p id="error_1_id_' + key + '" class="help-block autoadded"> <strong>' + response.errors[key] + '</strong></p>';
                                var p_element = $(el_text);
                                var input_id = 'id_' + key;
                                var label_search = "label[for='" + input_id + "']";
                                $('#hint_id_' + key, $formulario).before(p_element);

                                $(label_search).parents('div:first').removeClass('has-error').addClass('has-error');
                            }
                        }

                    });
                    // Put the results in a div
                    posting.done(function (data, textStatus, jqXHR) {
                        {#                        log_to_console("done data:", data);#}
                        {#                        log_to_console("done textStatus:", textStatus);#}
                        {#                        log_to_console("done jqXHR:", jqXHR);#}
                        {#                        // var content = jQuery(data);#}
                        {#                        log_to_console(jQuery(data));#}

                        {#                        var mensagem = "Documento N° " + data.document_number + " salvo com sucesso!";#}
                        {#                        humane.log(mensagem, {#}
                        {#                            timeout: 2500,#}
                        {#                            clickToClose: true,#}
                        {#                            addnCls: 'humane-sucess'#}
                        {#                        });#}
                        var a = jQuery(data);
                        console.log(data);
                        window.io = data;
                        {#                        console.log(a);#}
                        console.log("done");
                        excluir_modal_agora = true;
                        modal.modal('hide');


                    });
                    posting.always(function (data, textStatus, errorThrown) {
                        {#                        log_to_console("always");#}
                        {#                        requestRunning = false;#}
                        {#                        $botao_salvar.attr('')#}
                        $botao_salvar.prop('disabled', false);
                    });
                }).bind('ajax:complete', function () {

                    // tasks to do
                    console.log("ajax completo");


                });
            });


        })(window, jQuery);

    </script>
{% endif %}
