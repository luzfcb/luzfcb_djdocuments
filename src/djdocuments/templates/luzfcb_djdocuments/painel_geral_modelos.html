{% extends "luzfcb_djdocuments/painel_geral_modelos_base.html" %}
{% load staticfiles %}
{% load humanize %}
{% load luzfcb_djdocuments_tags %}
{% load spurl %}


{% block conteudo_app %}

    {% block cabecalho_pag %}

        <div class="page-title">
            <div class="pull-right">
                <small>
                    <a href="#" rel="popover" data-trigger="hover" data-html="true" data-placement="top"
                       data-content="<b>Novo Modelo:</b> Opção para criar modelos personalizados para uma das defensorias que seu usuário ({{ user.username }}) está vinculado"
                       data-original-title="Novo Modelo de documento">
                        <i class="elusive-question-sign color-blue"></i>
                    </a>
                </small>
                <span>
                    <a href="{% url 'documentos:criar_modelo' %}"
                       class="btn btn-primary djpopup djfullscreen">
                        <i class="icon-plus-sign icon-white"></i> Novo Modelo
                    </a>
{#                     <a href="{% url 'documentos:criar_tipo_documento' %}"#}
{#                       class="btn btn-primary djpopup djfullscreen" rel="tooltip" data-placement="bottom"#}
{#                       title="" data-original-title="Novo Tipo de Documento">#}
{#                        <i class="icon-plus-sign icon-white"></i> Novo Tipo#}
{#                    </a>#}
                </span>
            </div>
            <h3 class="pull-left">
                <i class="helper-font-24 icofont-copy color-yellow"></i>
                Modelos de documentos
                <small>
                    <a href="#" rel="popover" data-trigger="hover" data-html="true" data-placement="top"
                       data-content="<b>Modelo de Documentos:</b> Documentos de modelo que foram e podem ser criados para uma das defensorias que seu usuário ({{ user.username }}) está vinculado, e são utilizados para gerar outros documentos."
                       data-original-title="Modelo de Documentos">
                        <i class="elusive-question-sign color-blue"></i>
                    </a>
                </small>
            </h3>
            <form action="{{ search_url }}" method="get" id="search_field"
                  >
                <div class="controls pull-right">
                    <div class="input-icon-append" style="margin-right:28px;margin-top:1px;">
                        <span class="bold">Buscar: </span>
                        <span class="icon"><i class="icofont-search"></i></span>
                        <input name="q" class="grd-white" maxlength="30" type="text"
                               placeholder="Número ou Descrição...">
                    </div>
                </div>
            </form>

        </div>
    {% endblock %}
    {#    {% paginate object_list %}#}
    {% block conteudo_pag %}
        <table class="table table-striped">
            <thead>
            <tr>
                <th class="span1">N° Documento</th>
                <th class="span3">Descrição</th>
                <th class="span3">Tipo</th>
                <th class="span3">Defensoria</th>
                <th class="span1">Criado por</th>
{#                <th class="span1">Modificado por</th>#}
                <th class="span1">Data edição</th>
                <th class="span1">

                    <a href="#" rel="popover" data-trigger="hover" data-html="true" data-placement="top"
                       data-content="<b>Modelo de Documentos:</b> Documentos de modelo que foram e podem ser criados para uma das defensorias que seu usuário ({{ user.username }}) está vinculado, e são utilizados para gerar outros documentos."
                       data-original-title="Disponível">
                        Disponível?
                    </a>

                </th>
                <th class="span1">Ações</th>
            </tr>
            </thead>
            <tbody id="tbody-more" class="endless_page_template">
            <!-- tbody content -->

            {% for dado in object_list %}
                <tr>
                    <td>
                        {% spurl base=dado.get_preview_url add_query="no_nav=1" as url_para_visualizar_com_query %}
                        <i class="icofont-copy  color-yellow"></i>
                        <a href="{{ url_para_visualizar_com_query }}" class="btn-link">
                            {{ dado.identificador_versao }}
                        </a>
                    </td>
                    <td>
                        <small>
                            {{ dado.modelo_descricao }}
                        </small>
                    </td>
                    <td>
                        <small>
                            {{ dado.tipo_documento }}
                        </small>
                    </td>
                    <td>
                        {% if dado.grupo_dono %}
                          <small rel="tooltip" data-original-title="{{ dado.grupo_dono }}">
                            {{ dado.grupo_dono|truncatechars:36 }}
                          </small>

                        {% else %}
                          <small rel="tooltip" data-original-title="Modelo Global">
                            Modelo Global
                          </small>

                        {% endif %}

                    </td>
                    <td>
                        <small rel="tooltip" data-original-title="{{ dado.criado_por_nome }}">
                            {{ dado.criado_por_nome|truncatechars:20 }}
                        </small>
                    </td>
{#                    <td>#}
{#                        <small rel="tooltip" data-original-title="{{ dado.modificado_por_nome }}">#}
{#                            {{ dado.modificado_por_nome|truncatechars:20 }}#}
{#                        </small>#}
{#                    </td>#}

                    <td>
                        <small>
                            {{ dado.modificado_em }}
                        </small>
                    </td>
                    <td>
                        <div>
                          <div class="form-group ">
                            <div class="col-sm-10">
                            {% if dado.grupo_dono or user.is_superuser %}
                              <input name="modelo_pronto_para_utilizacao"
                                     class="modelo_pronto_para_utilizacao"
                                     type="checkbox"
                                     {% if dado.modelo_pronto_para_utilizacao %}checked="true" {% endif %}
                                     data-url="{% url 'documentos:modelo_ativardesativar_utilizacao' slug=dado.pk_uuid %}"
                                     data-toggle="toggle" data-on="Sim" data-off="Não"
                                     data-offstyle="danger"
                                     data-onstyle="success"
                                     data-size="small"
                              >
                            {% endif %}
                            </div>
                          </div>
                        </div>
                    </td>
                    <td>
                        <div>
                           {% spurl base=dado.get_preview_url query='next={{ next_success_url }}' as url_para_visualizar_com_query %}
                            <a href="{{ url_para_visualizar_com_query }}" class="btn-link">
                                <i class="icofont-search"></i> Visualizar
                            </a>
                            {% if dado.grupo_dono or user.is_superuser %}|
                              <a href="{{ dado.get_edit_url }}" class="btn-link">
                                <i class="elusive-file-edit"></i> Editar
                              </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6">
                        <div class="alert alert-info text-center">
                            {% if is_query %}
                                <b>Nenhum item encontrado com os termos: {{ is_query|safe }}</b>
                            {% else %}
                                <b>Nenhum Modelo cadastrado</b>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            <!-- end tbody content -->


            </tbody>
            {% if is_query %}
                <tfoot>
                <tr>
                    <td colspan="6">
                        <div class="text-center">
                            <form action="{{ search_url }}" method="get" id="search_field">
                                <input name="q" class="grd-white" type="hidden">
                                <input type="submit" class="btn btn-warning" value="Limpar pesquisa">

                            </form>
                        </div>
                    </td>
                </tr>
                </tfoot>
            {% endif %}
            <tfoot>
            <tr>
                <th class="span1">N° Documento</th>
                <th class="span3">Descrição</th>
                <th class="span3">Tipo</th>
                <th class="span3">Defensoria</th>
                <th class="span1">Criado por</th>
{#                <th class="span1">Modificado por</th>#}
                <th class="span1">Data edição</th>
                <th class="span1">Disponível?</th>
                <th class="span1">Ações</th>
            </tr>
            </tfoot>
        </table>
        <div class="pagination pagination-right">
            {% include 'luzfcb_djdocuments/_pagination2.html' %}
        </div>



        <div class="col-md-8 col-md-offset-2">
            {% block form_section %}{% endblock %}
        </div>
    {% endblock %}

{% endblock %}
{% block js_app %}

  {{ block.super }}

  <script type="application/javascript">
    $(function () {
      var requestRunning = false;
      $('.modelo_pronto_para_utilizacao').change(function () {
        var self = $(this);
        if (requestRunning) { // don't do anything if an AJAX request is pending
          return;
        }
        self.attr('disabled', true);

        var post_url = self.attr('data-url').replace(/\s/g, "");
        var is_checked = self.prop("checked");
        var data = {};
        if (is_checked === true) {
          data = {'modelo_pronto_para_utilizacao': true};
        }

        requestRunning = true;
        var posting = $.post(post_url, data, 'JSON');

        posting.fail(function (jqXHR, textStatus, errorThrown) {

          var errors = jqXHR.responseJSON;

          var msg = "Erro ao salvar documento" + errors.object_instance.pk_uuid + "\n";
          console.log(msg);

        });
        posting.done(function (data, textStatus, jqXHR) {

          var mensagem = "Documento N° " + data.object_instance.pk_uuid + " salvo com sucesso!";
          console.log(mensagem);
        });

        posting.always(function (data, textStatus, errorThrown) {
          self.attr('disabled', false);
          requestRunning = false;
        });
      });
    });

  </script>
{% endblock js_app %}
